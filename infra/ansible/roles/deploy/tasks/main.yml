---
- name: Check if application directory exists
  stat:
    path: "{{ app_directory }}"
  register: app_dir

- name: Clone application repository if it does not exist
  git:
    repo: "{{ repo_url }}"
    dest: "{{ app_directory }}"
    version: "{{ repo_branch }}"
    force: yes
  when: not app_dir.stat.exists

- name: Pull latest changes if repository exists
  git:
    repo: "{{ repo_url }}"
    dest: "{{ app_directory }}"
    version: "{{ repo_branch }}"
    force: yes
  when: app_dir.stat.exists
  register: git_pull

- name: Create traefik directory
  file:
    path: "{{ app_directory }}/traefik"
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'
    become: no

- name: Create letsencrypt directory
  file:
    path: "{{ app_directory }}/letsencrypt"
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'
    become: no

- name: Create acme.json file with correct permissions
  file:
    path: "{{ app_directory }}/letsencrypt/acme.json"
    state: touch
    owner: ubuntu
    group: ubuntu
    mode: '0600'
    become: no

- name: Deploy Traefik configuration
  template:
    src: traefik.yml.j2
    dest: "{{ app_directory }}/traefik/traefik.yml"
    owner: ubuntu
    group: ubuntu
    mode: '0644'
    become: no
    register: traefik_config

- name: Deploy .env file
  template:
    src: .env.j2
    dest: "{{ app_directory }}/.env"
    owner: ubuntu
    group: ubuntu
    mode: '0644'
    become: no
    register: env_file

- name: Create Docker network
  docker_network:
    name: web
    state: present
    become: no

- name: Stop running containers if configuration gets changed
  shell: |
    cd {{ app_directory }}
    docker-compose down
  when: git_pull.changed or git_clone.changed

- name: Pull Docker images
  shell: |
    cd {{ app_directory }}
    docker-compose pull
  register: docker_pull
  changed_when: "'Downloaded' in docker_pull.stdout or 'Pulled' in docker_pull.stdout"

- name: Build and start Docker containers
  shell: |
    cd {{ app_directory }}
    docker-compose up -d --build
  register: docker_up
  changed_when: "'Creating' in docker_up.stdout or 'Starting' in docker_up.stdout or 'Recreating' in docker_up.stdout"

- name: Wait for Docker services to be healthy
  shell: |
    cd {{ app_directory }}
    docker-compose ps
  register: compose_status
  until: compose_status.rc == 0
  retries: 5
  delay: 10
  changed_when: false

- name: Get running containers
  shell: docker ps
  become: no
  register: running_containers
  changed_when: false

- name: Show running containers
  debug:
    var: running_containers.stdout_lines

- name: Display Traefik logs
  shell: docker logs traefik --tail 20
  register: traefik_logs
  changed_when: false

- name: Display Traefik status message
  debug:
    msg: "Traefik is running. Check logs for SSL certificate generation."
